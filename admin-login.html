// admin-login.html à·„à·’ script à¶‘à¶š à¶´à·„à¶­ à¶šà·šà¶­à¶ºà¶§ replace à¶šà¶»à¶±à·Šà¶±
<script>
    // Database Authentication System
    let supabaseClient;
    let loginAttempts = 0;
    const MAX_LOGIN_ATTEMPTS = 5;
    
    // Initialize
    async function initialize() {
        console.log('ðŸ” Initializing database authentication...');
        
        // Wait for Supabase client
        const waitForClient = () => {
            if (window.supabaseClient && window.supabaseClient.from) {
                supabaseClient = window.supabaseClient;
                console.log('âœ… Supabase client ready');
                checkExistingSession();
            } else {
                console.log('â³ Waiting for Supabase client...');
                setTimeout(waitForClient, 200);
            }
        };
        
        waitForClient();
        
        // Check for logout parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('logout')) {
            localStorage.removeItem('adminSession');
            sessionStorage.removeItem('adminAuthenticated');
            showToast('Logged out successfully', 'success');
        }
        
        // Reset login attempts after 30 minutes
        setTimeout(() => {
            loginAttempts = 0;
        }, 30 * 60 * 1000);
    }

    // Check if already logged in
    async function checkExistingSession() {
        try {
            const sessionData = localStorage.getItem('adminSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                
                // Check if session is valid and not expired
                if (Date.now() < session.expiresAt) {
                    console.log('âœ… Valid session found, redirecting...');
                    window.location.href = 'admin.html';
                    return;
                } else {
                    // Clear expired session
                    localStorage.removeItem('adminSession');
                    showToast('Session expired. Please login again.', 'warning');
                }
            }
        } catch (error) {
            console.error('Error checking session:', error);
        }
    }

    // Handle Login
    async function handleLogin(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value.trim().toLowerCase();
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const loginText = document.getElementById('loginText');
        
        // Basic validation
        if (!email || !password) {
            errorDiv.textContent = 'Please enter both email and password';
            errorDiv.classList.remove('hidden');
            return;
        }
        
        // Check login attempts
        if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
            errorDiv.textContent = 'Too many failed attempts. Please try again in 30 minutes.';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = true;
            return;
        }
        
        // Disable button and show loading
        submitBtn.disabled = true;
        loginText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
        errorDiv.classList.add('hidden');

        try {
            if (!supabaseClient || !supabaseClient.from) {
                throw new Error('System not ready. Please refresh the page.');
            }

            console.log('ðŸ” Attempting login for:', email);
            
            // Use Supabase Auth for authentication
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                loginAttempts++;
                throw new Error('Invalid email or password');
            }
            
            console.log('âœ… Login successful for:', data.user.email);
            
            // Create session
            const session = {
                id: data.user.id,
                email: data.user.email,
                loggedInAt: Date.now(),
                expiresAt: Date.now() + (2 * 60 * 60 * 1000) // 2 hours
            };
            
            // Store session
            localStorage.setItem('adminSession', JSON.stringify(session));
            sessionStorage.setItem('adminAuthenticated', 'true');
            
            // Reset login attempts
            loginAttempts = 0;

            // Login successful
            showToast('âœ… Login successful! Redirecting...', 'success');
            
            setTimeout(() => {
                window.location.href = 'admin.html';
            }, 1000);

        } catch (error) {
            console.error('âŒ Login error:', error);
            
            let errorMessage = 'Login failed. Please try again.';
            let remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
            
            if (error.message.includes('Invalid')) {
                errorMessage = `Invalid email or password. ${remainingAttempts} attempts remaining.`;
            } else if (error.message.includes('Email not confirmed')) {
                errorMessage = 'Please confirm your email first';
            } else if (error.message.includes('Network')) {
                errorMessage = 'Network error. Check your connection.';
            }
            
            errorDiv.textContent = errorMessage;
            errorDiv.classList.remove('hidden');
            
            // Re-enable button
            submitBtn.disabled = false;
            loginText.textContent = 'Login';
            
            // Show error toast
            showToast('âŒ ' + errorMessage, 'error');
        }
    }

    // Toast Notification
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        
        toast.textContent = message;
        toast.className = 'show';
        
        if (type === 'success') {
            toast.style.background = 'rgba(16, 185, 129, 0.2)';
            toast.style.borderColor = '#10b981';
        } else if (type === 'error') {
            toast.style.background = 'rgba(239, 68, 68, 0.2)';
            toast.style.borderColor = '#ef4444';
        } else if (type === 'warning') {
            toast.style.background = 'rgba(245, 158, 11, 0.2)';
            toast.style.borderColor = '#f59e0b';
        }
        
        setTimeout(() => {
            toast.className = '';
        }, 3000);
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', initialize);
    
    // Handle Enter key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.target.closest('button')) {
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn && !submitBtn.disabled) {
                event.preventDefault();
                submitBtn.click();
            }
        }
    });
    
    // Password visibility toggle
    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const eyeIcon = document.querySelector('.show-password i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.className = 'fas fa-eye-slash';
        } else {
            passwordInput.type = 'password';
            eyeIcon.className = 'fas fa-eye';
        }
    }
    
    // Check password strength
    function checkPasswordStrength(password) {
        const strengthDiv = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        
        if (!password) {
            strengthDiv.style.display = 'none';
            return;
        }
        
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        strengthDiv.style.display = 'block';
        
        if (strength < 2) {
            strengthDiv.className = 'password-strength strength-weak';
            strengthText.textContent = 'Weak';
        } else if (strength < 4) {
            strengthDiv.className = 'password-strength strength-medium';
            strengthText.textContent = 'Medium';
        } else {
            strengthDiv.className = 'password-strength strength-strong';
            strengthText.textContent = 'Strong';
        }
    }
</script>
