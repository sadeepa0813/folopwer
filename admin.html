<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - 3D Store</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional Admin Styles */
        .stock-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .stock-in { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .stock-out { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .stock-low { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 18px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.95rem;
            min-height: 50px;
            flex: 1;
            min-width: 160px;
        }
        
        .action-btn:hover {
            background: rgba(99, 102, 241, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.2);
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .search-box i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-chip {
            padding: 8px 18px;
            background: rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            font-weight: 500;
        }
        
        .filter-chip.active {
            background: rgba(99, 102, 241, 0.25);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        
        .customer-phone-link {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .customer-phone-link:hover {
            text-decoration: underline;
            color: var(--primary);
        }
        
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .order-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .confirm-btn { 
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .cancel-btn { 
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .view-btn { 
            background: linear-gradient(135deg, #6366f1, #818cf8);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .order-action-btn:hover {
            transform: translateY(-3px) scale(1.05);
        }
        
        .stock-input {
            width: 90px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            text-align: center;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .stock-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        .today-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .stats-card {
            position: relative;
            overflow: hidden;
            padding: 25px;
        }
        
        .stats-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .stats-card.products::after { 
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .stats-card.orders::after { 
            background: linear-gradient(90deg, var(--accent), #22d3ee);
        }
        .stats-card.revenue::after { 
            background: linear-gradient(90deg, var(--success), #84cc16);
        }
        .stats-card.pending::after { 
            background: linear-gradient(90deg, var(--warning), #f59e0b);
        }
        
        /* Admin Specific Styles */
        .admin-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s, transform 0.4s;
        }
        
        .admin-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(16, 185, 129, 0.25);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: 0.5px;
        }
        
        .nav-logo span:first-child {
            font-size: 2.2rem;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .nav-item {
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.8);
            min-height: 50px;
            min-width: 50px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .nav-item:hover {
            background: rgba(16, 185, 129, 0.15);
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(52, 211, 153, 0.15));
            color: var(--primary);
            border: 1px solid rgba(16, 185, 129, 0.4);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 23, 42, 0.3);
        }
        
        .table-responsive table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table-responsive th {
            text-align: left;
            padding: 18px 20px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            color: rgba(255, 255, 255, 0.95);
            font-weight: 700;
            border-bottom: 2px solid rgba(16, 185, 129, 0.3);
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-responsive td {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            vertical-align: middle;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        .table-responsive tr:hover td {
            background: rgba(16, 185, 129, 0.08);
        }
        
        .table-responsive tr:last-child td {
            border-bottom: none;
        }
        
        /* Button Styles for Admin */
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: white;
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f59e0b);
            color: white;
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f87171);
            color: white;
            border: none;
        }
        
        .filter-btn {
            padding: 10px 20px;
            font-size: 0.95rem;
            min-height: 45px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .filter-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.25);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            min-height: 40px;
            border-radius: 10px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            nav {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                backdrop-filter: blur(20px);
            }
            
            .nav-logo {
                font-size: 1.2rem;
            }
            
            .nav-links {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 10px;
                justify-content: center;
                scrollbar-width: none;
            }
            
            .nav-links::-webkit-scrollbar {
                display: none;
            }
            
            .nav-item {
                white-space: nowrap;
                padding: 10px 16px;
                font-size: 0.9rem;
                min-height: 45px;
            }
            
            .table-responsive {
                font-size: 0.85rem;
                margin: 0 -1rem;
                width: calc(100% + 2rem);
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .table-responsive th,
            .table-responsive td {
                padding: 12px 15px;
            }
            
            .order-actions {
                flex-direction: row;
                justify-content: center;
            }
            
            .order-action-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .quick-actions {
                gap: 8px;
            }
            
            .action-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                min-width: 140px;
                flex: 1 1 calc(50% - 8px);
            }
            
            .stats-card {
                padding: 20px;
            }
            
            .stats-card h3.mono {
                font-size: 1.8rem !important;
            }
            
            .filter-options {
                justify-content: center;
                gap: 8px;
            }
            
            .filter-chip {
                padding: 6px 14px;
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 480px) {
            .action-btn {
                flex: 1 1 100%;
                min-width: auto;
            }
            
            .table-responsive th,
            .table-responsive td {
                padding: 10px 12px;
                font-size: 0.82rem;
            }
            
            .stats-card {
                padding: 15px;
            }
            
            .stats-card h3.mono {
                font-size: 1.6rem !important;
            }
            
            .nav-item {
                padding: 8px 12px;
                font-size: 0.85rem;
                gap: 8px;
            }
        }
        
        /* Tracking ID Copy Button */
        .tracking-id {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tracking-id:hover {
            color: var(--primary);
        }
        
        .copy-btn {
            background: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .copy-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
        }
        
        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(16, 185, 129, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            color: rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }
        
        .empty-state-title {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }
        
        .empty-state-message {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 25px;
            font-size: 1rem;
        }
        
        /* Pulse Animation for New Orders */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .new-order {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Particle Background Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- Navigation -->
    <nav>
        <div class="nav-logo">
            <span>‚öôÔ∏è</span>
            <span>ADMIN DASHBOARD</span>
        </div>
        <div class="nav-links">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> <span class="nav-text">Dashboard</span>
            </div>
            <div class="nav-item" onclick="showSection('products')">
                <i class="fas fa-box"></i> <span class="nav-text">Products</span>
            </div>
            <div class="nav-item" onclick="showSection('orders')">
                <i class="fas fa-shopping-cart"></i> <span class="nav-text">Orders</span>
                <span id="pendingBadge" class="today-badge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('customers')">
                <i class="fas fa-users"></i> <span class="nav-text">Customers</span>
            </div>
            <button class="btn-3d btn-danger btn-small" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Logout</span>
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboard" class="admin-section active">
            <h2 class="mb-3">üìä Dashboard Overview</h2>
            <p style="opacity: 0.8; margin-bottom: 30px; font-size: 1.1rem;">
                Welcome back, <span id="adminEmail" style="color: var(--primary); font-weight: 600;">Admin</span>! 
                <span id="lastLogin" style="opacity: 0.6; font-size: 0.9rem;">Last login: -</span>
            </p>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-btn" onclick="showSection('products'); document.getElementById('addProductBtn').click();">
                    <i class="fas fa-plus-circle"></i> Add Product
                </div>
                <div class="action-btn" onclick="showSection('orders'); filterOrders('today');">
                    <i class="fas fa-calendar-day"></i> Today's Orders
                </div>
                <div class="action-btn" onclick="showOutOfStock()">
                    <i class="fas fa-exclamation-triangle"></i> Out of Stock
                </div>
                <div class="action-btn" onclick="exportOrders()">
                    <i class="fas fa-download"></i> Export Orders
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px;">
                <div class="card-3d stats-card products">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="font-size: 2.8rem; color: var(--primary);">
                            <i class="fas fa-box"></i>
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <h3 class="mono" id="totalProducts" style="font-size: 2.8rem; color: var(--primary); margin-bottom: 5px;">0</h3>
                    <p style="opacity: 0.8; font-weight: 600; margin-bottom: 8px;">Total Products</p>
                    <small id="stockInfo" style="opacity: 0.6; font-size: 0.85rem;">üîÑ Loading stock info...</small>
                </div>
                
                <div class="card-3d stats-card orders">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="font-size: 2.8rem; color: var(--accent);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <h3 class="mono" id="totalOrders" style="font-size: 2.8rem; color: var(--accent); margin-bottom: 5px;">0</h3>
                    <p style="opacity: 0.8; font-weight: 600; margin-bottom: 8px;">Total Orders</p>
                    <small id="todayOrders" style="opacity: 0.6; font-size: 0.85rem;">üìÖ Today: 0</small>
                </div>
                
                <div class="card-3d stats-card pending">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="font-size: 2.8rem; color: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <h3 class="mono" id="pendingOrders" style="font-size: 2.8rem; color: var(--warning); margin-bottom: 5px;">0</h3>
                    <p style="opacity: 0.8; font-weight: 600; margin-bottom: 8px;">Pending Orders</p>
                    <small style="opacity: 0.6; font-size: 0.85rem;">‚ö†Ô∏è Need attention</small>
                </div>
                
                <div class="card-3d stats-card revenue">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="font-size: 2.8rem; color: var(--success);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <h3 class="mono" id="totalRevenue" style="font-size: 2rem; color: var(--success); margin-bottom: 5px;">Rs. 0</h3>
                    <p style="opacity: 0.8; font-weight: 600; margin-bottom: 8px;">Total Revenue</p>
                    <small id="todayRevenue" style="opacity: 0.6; font-size: 0.85rem;">üí∞ Today: Rs. 0</small>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="card-3d">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 class="mb-0" style="color: var(--primary);">
                        <i class="fas fa-history"></i> Recent Orders
                    </h3>
                    <button class="btn-3d btn-primary" onclick="showSection('orders')">
                        View All <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                <div id="recentOrdersTable" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading recent orders...</p>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 class="mb-0" style="color: var(--primary);">
                    <i class="fas fa-boxes"></i> Product Management
                </h2>
                <button id="addProductBtn" class="btn-3d btn-primary" onclick="showAddProductForm()">
                    <i class="fas fa-plus-circle"></i> Add New Product
                </button>
            </div>
            
            <!-- Search & Filters -->
            <div class="card-3d mb-3">
                <div class="search-box">
                    <input type="text" id="productSearch" placeholder="üîç Search products by name or description..." 
                           onkeyup="searchProducts()">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="filter-options">
                    <div class="filter-chip active" onclick="filterProducts('all')">
                        <i class="fas fa-layer-group"></i> All Products
                    </div>
                    <div class="filter-chip" onclick="filterProducts('in_stock')">
                        <i class="fas fa-check-circle"></i> In Stock
                    </div>
                    <div class="filter-chip" onclick="filterProducts('out_of_stock')">
                        <i class="fas fa-times-circle"></i> Out of Stock
                    </div>
                    <div class="filter-chip" onclick="filterProducts('low_stock')">
                        <i class="fas fa-exclamation-circle"></i> Low Stock
                    </div>
                </div>
            </div>

            <!-- Add Product Form (Initially Hidden) -->
            <div id="addProductFormContainer" class="card-3d mb-3" style="display: none; border: 2px dashed rgba(16, 185, 129, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 class="mb-0" style="color: var(--primary);">
                        <i class="fas fa-plus-circle"></i> Add New Product
                    </h3>
                    <button class="btn-3d btn-secondary btn-small" onclick="hideAddProductForm()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                <form id="addProductForm" onsubmit="handleAddProduct(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> Product Name *</label>
                            <input type="text" name="name" required placeholder="e.g., Wireless Headphones">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-money-bill-wave"></i> Price (Rs.) *</label>
                            <input type="number" name="price" required placeholder="15000" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-boxes"></i> Stock Quantity *</label>
                            <input type="number" name="stock" required placeholder="100" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-bell"></i> Low Stock Alert</label>
                            <input type="number" name="low_stock_alert" placeholder="10" min="0" value="5">
                            <small style="opacity: 0.6;">Alert when stock goes below this</small>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label><i class="fas fa-align-left"></i> Description *</label>
                            <textarea name="description" required rows="3" placeholder="Brief product description..."></textarea>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label><i class="fas fa-image"></i> Product Image *</label>
                            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
                                <label for="productImage" class="btn-3d btn-primary" style="cursor: pointer; margin: 0;">
                                    <i class="fas fa-cloud-upload-alt"></i> Choose Image
                                </label>
                                <input type="file" id="productImage" accept="image/*" style="display: none;" onchange="previewImage(event)" required>
                                <span id="fileName" style="opacity: 0.8; font-size: 0.95rem;">No file chosen</span>
                            </div>
                            <div id="imagePreview" class="hidden" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn-3d btn-secondary" onclick="hideAddProductForm()" style="flex: 1;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-3d btn-primary" style="flex: 2;">
                            <i class="fas fa-save"></i> Add Product
                        </button>
                    </div>
                </form>
            </div>

            <!-- Products List -->
            <div class="card-3d">
                <div id="productsTableContainer" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading products...</p>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="admin-section">
            <h2 class="mb-3" style="color: var(--primary);">
                <i class="fas fa-shopping-cart"></i> Order Management
            </h2>
            
            <!-- Order Filters -->
            <div class="card-3d mb-3">
                <div class="search-box">
                    <input type="text" id="orderSearch" placeholder="üîç Search by customer, phone, or tracking ID..." 
                           onkeyup="searchOrders()">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="filter-options">
                    <button class="btn-3d btn-secondary filter-btn active" onclick="filterOrders('all')">
                        <i class="fas fa-list"></i> All Orders
                    </button>
                    <button class="btn-3d btn-warning filter-btn" onclick="filterOrders('Pending')">
                        <i class="fas fa-clock"></i> Pending
                    </button>
                    <button class="btn-3d btn-success filter-btn" onclick="filterOrders('Confirmed')">
                        <i class="fas fa-check-circle"></i> Confirmed
                    </button>
                    <button class="btn-3d btn-danger filter-btn" onclick="filterOrders('Cancelled')">
                        <i class="fas fa-times-circle"></i> Cancelled
                    </button>
                    <button class="btn-3d btn-primary filter-btn" onclick="filterOrders('today')">
                        <i class="fas fa-calendar-day"></i> Today
                    </button>
                    <button class="btn-3d btn-secondary filter-btn" onclick="filterOrders('this_week')">
                        <i class="fas fa-calendar-week"></i> This Week
                    </button>
                </div>
            </div>
            
            <!-- Bulk Actions -->
            <div class="card-3d mb-3" style="padding: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <select id="bulkAction" class="form-control" style="flex: 1; min-width: 200px; padding: 12px;">
                        <option value="">‚ö° Bulk Action</option>
                        <option value="confirm">‚úÖ Confirm Selected</option>
                        <option value="cancel">‚ùå Cancel Selected</option>
                        <option value="delete">üóëÔ∏è Delete Selected</option>
                    </select>
                    <button class="btn-3d btn-primary" onclick="applyBulkAction()" style="min-width: 120px;">
                        <i class="fas fa-play"></i> Apply
                    </button>
                    <span id="selectedCount" style="opacity: 0.8; margin-left: 10px; font-weight: 500;">
                        <i class="fas fa-check-square"></i> 0 orders selected
                    </span>
                </div>
            </div>
            
            <div class="card-3d">
                <div id="ordersTableContainer" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading orders...</p>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers" class="admin-section">
            <h2 class="mb-3" style="color: var(--primary);">
                <i class="fas fa-users"></i> Customer Management
            </h2>
            
            <!-- Customer Search -->
            <div class="card-3d mb-3">
                <div class="search-box">
                    <input type="text" id="customerSearch" placeholder="üîç Search customers by name or phone number..." 
                           onkeyup="searchCustomers()">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            
            <div class="card-3d">
                <div id="customersTableContainer" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading customers...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 4rem; color: var(--danger); margin-bottom: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 style="margin-bottom: 10px; color: var(--danger);">Confirm Delete</h3>
                <p style="opacity: 0.8; margin-bottom: 5px;">This action cannot be undone</p>
            </div>
            <p id="deleteMessage" style="margin-bottom: 30px; text-align: center; font-size: 1.1rem;"></p>
            <div style="display: flex; gap: 15px;">
                <button class="btn-3d btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-3d btn-danger" onclick="confirmDelete()" style="flex: 1;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal-overlay" id="editProductModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditProductModal()">&times;</span>
            <div id="editProductModalBody"></div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal-overlay" id="orderDetailsModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeOrderDetailsModal()">&times;</span>
            <div id="orderDetailsModalBody"></div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal-overlay" id="customerDetailsModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCustomerDetailsModal()">&times;</span>
            <div id="customerDetailsModalBody"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="background.js"></script>
    <script>
        /**
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * 3D STORE - ENHANCED ADMIN PANEL
         * Mobile Optimized with Tracking Copy & Better UI
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         */

        // Global state
        let currentFilter = 'all';
        let deleteTarget = null;
        let editTarget = null;
        let allOrders = [];
        let allProducts = [];
        let selectedOrders = new Set();

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Admin Panel Loading...');
            
            // Wait for Supabase client
            await waitForSupabase();
            
            // Check authentication
            await checkAuth();
            
            // Load initial data
            await loadInitialData();
            
            console.log('‚úÖ Admin Panel Ready!');
        });

        async function waitForSupabase() {
            return new Promise((resolve) => {
                const checkClient = () => {
                    if (window.supabaseClient) {
                        console.log('‚úÖ Supabase client found');
                        resolve(true);
                        return;
                    }
                    
                    console.log('‚è≥ Waiting for Supabase client...');
                    setTimeout(checkClient, 500);
                };
                
                checkClient();
            });
        }

        async function checkAuth() {
            try {
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Auth error:', error);
                    redirectToLogin();
                    return false;
                }
                
                if (!session) {
                    console.log('‚ùå No active session');
                    redirectToLogin();
                    return false;
                }
                
                console.log('‚úÖ Authenticated as:', session.user.email);
                document.getElementById('adminEmail').textContent = session.user.email;
                document.getElementById('lastLogin').textContent = 'Last login: ' + new Date().toLocaleString();
                
                return true;
                
            } catch (error) {
                console.error('Auth check error:', error);
                redirectToLogin();
                return false;
            }
        }

        async function loadInitialData() {
            try {
                await Promise.all([
                    loadDashboardStats(),
                    loadProducts(),
                    loadOrders()
                ]);
                
                setupRealtime();
                
            } catch (error) {
                console.error('Initial data load error:', error);
                showToast('Failed to load data', 'error');
            }
        }

        function redirectToLogin() {
            setTimeout(() => {
                window.location.href = 'admin-login.html';
            }, 1500);
        }

        // ==================== NAVIGATION ====================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Activate corresponding nav item
                const navItems = document.querySelectorAll('.nav-item');
                const sectionMap = {
                    'dashboard': 0,
                    'products': 1,
                    'orders': 2,
                    'customers': 3
                };
                
                if (sectionMap[sectionId] !== undefined) {
                    navItems[sectionMap[sectionId]].classList.add('active');
                }
                
                // Load data for section
                if (sectionId === 'dashboard') {
                    loadDashboardStats();
                } else if (sectionId === 'products') {
                    loadProducts();
                } else if (sectionId === 'orders') {
                    loadOrders();
                }
            }
        }

        // ==================== DASHBOARD ====================
        async function loadDashboardStats() {
            try {
                console.log('üìä Loading dashboard stats...');
                
                const [productsRes, ordersRes, pendingRes] = await Promise.all([
                    window.supabaseClient.from('products').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.from('orders').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.from('orders').select('*', { count: 'exact', head: true }).eq('status', 'Pending')
                ]);
                
                // Calculate revenue
                const { data: revenueData } = await window.supabaseClient
                    .from('orders')
                    .select('total')
                    .eq('status', 'Confirmed');
                
                const totalRevenue = revenueData?.reduce((sum, order) => sum + (order.total || 0), 0) || 0;
                
                // Today's stats
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { count: todayOrders } = await window.supabaseClient
                    .from('orders')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today.toISOString());
                
                const { data: todayRevenueData } = await window.supabaseClient
                    .from('orders')
                    .select('total')
                    .eq('status', 'Confirmed')
                    .gte('created_at', today.toISOString());
                
                const todayRevenue = todayRevenueData?.reduce((sum, order) => sum + (order.total || 0), 0) || 0;
                
                // Stock info
                const { data: products } = await window.supabaseClient
                    .from('products')
                    .select('stock');
                
                let inStock = 0, outOfStock = 0, lowStock = 0;
                if (products) {
                    products.forEach(p => {
                        const stock = p.stock || 0;
                        if (stock > 10) inStock++;
                        else if (stock === 0) outOfStock++;
                        else if (stock <= 10) lowStock++;
                    });
                }
                
                // Update UI
                document.getElementById('totalProducts').textContent = productsRes.count || 0;
                document.getElementById('totalOrders').textContent = ordersRes.count || 0;
                document.getElementById('pendingOrders').textContent = pendingRes.count || 0;
                document.getElementById('totalRevenue').textContent = `Rs. ${totalRevenue.toLocaleString()}`;
                document.getElementById('todayOrders').textContent = `Today: ${todayOrders || 0}`;
                document.getElementById('todayRevenue').textContent = `Today: Rs. ${todayRevenue.toLocaleString()}`;
                document.getElementById('stockInfo').textContent = `${inStock} in stock, ${lowStock} low, ${outOfStock} out`;
                
                // Update pending badge
                const pendingBadge = document.getElementById('pendingBadge');
                pendingBadge.textContent = pendingRes.count || 0;
                pendingBadge.style.display = pendingRes.count > 0 ? 'inline-block' : 'none';
                
                // Load recent orders
                await loadRecentOrders();
                
                console.log('‚úÖ Dashboard loaded');
                
            } catch (error) {
                console.error('‚ùå Dashboard error:', error);
            }
        }

        async function loadRecentOrders() {
            try {
                const { data: orders } = await window.supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                const container = document.getElementById('recentOrdersTable');
                
                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-title">No Orders Yet</div>
                            <div class="empty-state-message">When customers place orders, they'll appear here</div>
                        </div>
                    `;
                    return;
                }
                
                const html = orders.map(order => `
                    <tr onclick="viewOrderDetails(${JSON.stringify(order).replace(/'/g, "&#39;")})" style="cursor: pointer;">
                        <td>
                            <div class="tracking-id" onclick="copyTrackingId('${order.tracking_id}', event)">
                                <span class="mono">${order.tracking_id}</span>
                                <button class="copy-btn" title="Copy Tracking ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                        <td><strong>${order.customer_name}</strong></td>
                        <td>
                            <a href="tel:${order.phone_number}" class="customer-phone-link" onclick="event.stopPropagation()">
                                ${order.phone_number}
                            </a>
                        </td>
                        <td class="mono"><strong>Rs. ${order.total.toLocaleString()}</strong></td>
                        <td><span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tracking ID</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>${html}</tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Recent orders error:', error);
            }
        }

        // ==================== PRODUCT MANAGEMENT ====================
        async function loadProducts() {
            try {
                console.log('üì¶ Loading products...');
                
                const { data: products, error } = await window.supabaseClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allProducts = products || [];
                displayProducts(allProducts);
                
                console.log(`‚úÖ Loaded ${products.length} products`);
                
            } catch (error) {
                console.error('‚ùå Products error:', error);
                showToast('Failed to load products', 'error');
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('productsTableContainer');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-title">No Products Found</div>
                        <div class="empty-state-message">Add your first product to get started</div>
                        <button class="btn-3d btn-primary" onclick="showAddProductForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Add First Product
                        </button>
                    </div>
                `;
                return;
            }
            
            const html = products.map(product => `
                <tr>
                    <td>
                        <img src="${product.image_url || 'https://via.placeholder.com/60'}" 
                             alt="${product.name}"
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 10px;"
                             onerror="this.src='https://via.placeholder.com/60'">
                    </td>
                    <td>
                        <strong style="color: var(--primary);">${product.name}</strong>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 3px;">
                            ${product.description ? product.description.substring(0, 50) + '...' : 'No description'}
                        </div>
                        ${(product.stock || 0) <= 5 && (product.stock || 0) > 0 ? 
                            '<div style="color: var(--warning); font-size: 0.8rem; margin-top: 5px;">‚ö†Ô∏è Low stock warning</div>' : ''}
                    </td>
                    <td class="mono" style="font-weight: 700; color: var(--success);">
                        Rs. ${(product.price || 0).toLocaleString()}
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" 
                                   class="stock-input" 
                                   value="${product.stock || 0}" 
                                   min="0"
                                   onchange="updateStock(${product.id}, this.value)"
                                   style="${(product.stock || 0) === 0 ? 'border-color: var(--danger); background: rgba(239, 68, 68, 0.1);' : ''}">
                            <span class="stock-badge ${getStockClass(product.stock || 0)}">
                                <i class="fas fa-${getStockIcon(product.stock || 0)}"></i>
                                ${getStockText(product.stock || 0)}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn-3d btn-primary btn-small" 
                                    onclick='openEditProductModal(${JSON.stringify(product).replace(/'/g, "&#39;")})'
                                    title="Edit Product">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-3d btn-danger btn-small" 
                                    onclick="openDeleteModal('product', ${product.id}, '${product.name.replace(/'/g, "\\'")}')"
                                    title="Delete Product">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${html}</tbody>
                    </table>
                </div>
            `;
        }

        function getStockClass(stock) {
            if (stock === 0) return 'stock-out';
            if (stock <= 5) return 'stock-low';
            return 'stock-in';
        }

        function getStockIcon(stock) {
            if (stock === 0) return 'times-circle';
            if (stock <= 5) return 'exclamation-circle';
            return 'check-circle';
        }

        function getStockText(stock) {
            if (stock === 0) return 'Out of Stock';
            if (stock <= 5) return `Low (${stock})`;
            return `In Stock (${stock})`;
        }

        async function updateStock(productId, newStock) {
            const stock = parseInt(newStock);
            
            if (isNaN(stock) || stock < 0) {
                showToast('‚ùå Invalid stock quantity', 'error');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('products')
                    .update({ 
                        stock: stock,
                        status: stock > 0 ? 'in_stock' : 'out_of_stock',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);
                
                if (error) throw error;
                
                showToast('‚úÖ Stock updated successfully', 'success');
                
                // Update local data
                const productIndex = allProducts.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    allProducts[productIndex].stock = stock;
                    allProducts[productIndex].status = stock > 0 ? 'in_stock' : 'out_of_stock';
                }
                
                // Refresh display
                displayProducts(allProducts);
                
            } catch (error) {
                console.error('‚ùå Stock update error:', error);
                showToast('‚ùå Failed to update stock', 'error');
            }
        }

        // ==================== ADD PRODUCT ====================
        function showAddProductForm() {
            document.getElementById('addProductFormContainer').style.display = 'block';
            window.scrollTo({ 
                top: document.getElementById('addProductFormContainer').offsetTop - 100, 
                behavior: 'smooth' 
            });
        }

        function hideAddProductForm() {
            document.getElementById('addProductFormContainer').style.display = 'none';
            document.getElementById('addProductForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('fileName').textContent = 'No file chosen';
        }

        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const fileName = document.getElementById('fileName');
            
            if (file) {
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    showToast('‚ùå Image must be less than 5MB', 'error');
                    event.target.value = '';
                    return;
                }
                
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
                if (!allowedTypes.includes(file.type)) {
                    showToast('‚ùå Only JPEG, PNG and WebP images allowed', 'error');
                    event.target.value = '';
                    return;
                }
                
                fileName.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div style="position: relative;">
                            <img src="${e.target.result}" 
                                 alt="Preview" 
                                 style="max-width: 100%; max-height: 250px; border-radius: 12px; border: 2px solid rgba(16, 185, 129, 0.3);">
                            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.85rem;">
                                Preview
                            </div>
                        </div>
                    `;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleAddProduct(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            try {
                const productData = {
                    name: form.name.value.trim(),
                    price: parseFloat(form.price.value),
                    stock: parseInt(form.stock.value) || 0,
                    description: form.description.value.trim()
                };
                
                if (!productData.name || productData.name.length < 2) {
                    throw new Error('Product name is required (min 2 characters)');
                }
                
                if (!productData.price || productData.price <= 0) {
                    throw new Error('Price must be greater than 0');
                }
                
                if (productData.stock < 0) {
                    throw new Error('Stock cannot be negative');
                }
                
                const imageFile = document.getElementById('productImage').files[0];
                if (!imageFile) {
                    throw new Error('Please select a product image');
                }
                
                console.log('üì§ Starting product upload...');
                
                const fileExt = imageFile.name.split('.').pop();
                const fileName = `product_${Date.now()}.${fileExt}`;
                
                const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                    .from('product-images')
                    .upload(fileName, imageFile);
                
                if (uploadError) throw uploadError;
                
                const { data: { publicUrl } } = window.supabaseClient.storage
                    .from('product-images')
                    .getPublicUrl(fileName);
                
                const { data, error } = await window.supabaseClient
                    .from('products')
                    .insert([{
                        name: productData.name,
                        price: productData.price,
                        stock: productData.stock,
                        description: productData.description,
                        image_url: publicUrl,
                        status: productData.stock > 0 ? 'in_stock' : 'out_of_stock',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('‚úÖ Product added successfully!', 'success');
                hideAddProductForm();
                await loadProducts();
                await loadDashboardStats();
                
            } catch (error) {
                console.error('‚ùå Add product error:', error);
                showToast('‚ùå ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Product';
            }
        }

        // ==================== ORDER MANAGEMENT ====================
        async function loadOrders() {
            try {
                console.log('üõí Loading orders...');
                
                const { data: orders, error } = await window.supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allOrders = orders || [];
                displayOrders(allOrders);
                
                console.log(`‚úÖ Loaded ${orders.length} orders`);
                
            } catch (error) {
                console.error('‚ùå Orders error:', error);
                showToast('Failed to load orders', 'error');
            }
        }

        function displayOrders(orders) {
            let filteredOrders = orders;
            
            if (currentFilter === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filteredOrders = orders.filter(o => new Date(o.created_at) >= today);
            } else if (currentFilter === 'this_week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                filteredOrders = orders.filter(o => new Date(o.created_at) >= weekAgo);
            } else if (currentFilter !== 'all') {
                filteredOrders = orders.filter(o => o.status === currentFilter);
            }
            
            const container = document.getElementById('ordersTableContainer');
            
            if (!filteredOrders || filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-title">No Orders Found</div>
                        <div class="empty-state-message">
                            ${currentFilter === 'today' ? 'No orders placed today' : 
                              currentFilter === 'this_week' ? 'No orders this week' : 
                              'No orders to display for the selected filter'}
                        </div>
                    </div>
                `;
                return;
            }
            
            const html = filteredOrders.map(order => `
                <tr>
                    <td>
                        <div class="tracking-id" onclick="copyTrackingId('${order.tracking_id}', event)">
                            <span class="mono" style="font-size: 0.9rem;">${order.tracking_id}</span>
                            <button class="copy-btn" title="Copy Tracking ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <strong>${order.customer_name}</strong>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 3px;">
                            ${order.address ? order.address.substring(0, 30) + '...' : 'No address'}
                        </div>
                    </td>
                    <td>
                        <a href="tel:${order.phone_number}" class="customer-phone-link">
                            <i class="fas fa-phone"></i> ${order.phone_number}
                        </a>
                    </td>
                    <td>
                        <strong>${order.product_name}</strong>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 3px;">
                            Qty: ${order.quantity}
                        </div>
                    </td>
                    <td class="mono" style="font-weight: 700; color: var(--success);">
                        Rs. ${order.total.toLocaleString()}
                    </td>
                    <td>
                        <span class="status-badge status-${order.status.toLowerCase()}">
                            <i class="fas fa-${getStatusIcon(order.status)}"></i>
                            ${order.status}
                        </span>
                    </td>
                    <td style="font-size: 0.9rem; opacity: 0.8;">
                        ${new Date(order.created_at).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                        ${isToday(order.created_at) ? '<span class="today-badge">Today</span>' : ''}
                    </td>
                    <td>
                        <div class="order-actions">
                            <button class="order-action-btn view-btn" 
                                    onclick='viewOrderDetails(${JSON.stringify(order).replace(/'/g, "&#39;")})' 
                                    title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${order.status === 'Pending' ? `
                                <button class="order-action-btn confirm-btn" 
                                        onclick="updateOrderStatus('${order.tracking_id}', 'Confirmed')"
                                        title="Confirm Order">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            ${order.status !== 'Cancelled' ? `
                                <button class="order-action-btn cancel-btn" 
                                        onclick="updateOrderStatus('${order.tracking_id}', 'Cancelled')"
                                        title="Cancel Order">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Tracking ID</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Product</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${html}</tbody>
                    </table>
                </div>
            `;
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'Pending': return 'clock';
                case 'Confirmed': return 'check-circle';
                case 'Cancelled': return 'times-circle';
                default: return 'question-circle';
            }
        }

        function filterOrders(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const clickedBtn = event.target.closest('.filter-btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            displayOrders(allOrders);
        }

        function searchOrders() {
            const query = document.getElementById('orderSearch').value.toLowerCase();
            const filtered = allOrders.filter(o => 
                o.customer_name.toLowerCase().includes(query) ||
                o.phone_number.includes(query) ||
                o.tracking_id.toLowerCase().includes(query) ||
                o.product_name.toLowerCase().includes(query)
            );
            displayOrders(filtered);
        }

        function searchProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(query) ||
                (p.description && p.description.toLowerCase().includes(query))
            );
            displayProducts(filtered);
        }

        async function updateOrderStatus(trackingId, newStatus) {
            const action = newStatus === 'Confirmed' ? 'confirm' : 'cancel';
            
            if (!confirm(`Are you sure you want to ${action} this order?`)) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('orders')
                    .update({ 
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('tracking_id', trackingId);
                
                if (error) throw error;
                
                showToast(`‚úÖ Order ${newStatus.toLowerCase()}!`, 'success');
                
                // Update local data
                const orderIndex = allOrders.findIndex(o => o.tracking_id === trackingId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = newStatus;
                    allOrders[orderIndex].updated_at = new Date().toISOString();
                }
                
                // Refresh display
                displayOrders(allOrders);
                await loadDashboardStats();
                
            } catch (error) {
                console.error('‚ùå Order update error:', error);
                showToast('‚ùå Failed to update order', 'error');
            }
        }

        // ==================== TRACKING ID COPY ====================
        function copyTrackingId(trackingId, event) {
            if (event) event.stopPropagation();
            
            navigator.clipboard.writeText(trackingId)
                .then(() => {
                    showToast('üìã Tracking ID copied to clipboard!', 'success');
                    
                    // Visual feedback
                    const copyBtn = event ? event.target.closest('.tracking-id') : null;
                    if (copyBtn) {
                        copyBtn.style.color = 'var(--success)';
                        setTimeout(() => {
                            copyBtn.style.color = '';
                        }, 1000);
                    }
                })
                .catch(err => {
                    console.error('Copy failed:', err);
                    showToast('‚ùå Failed to copy', 'error');
                });
        }

        // ==================== VIEW ORDER DETAILS ====================
        function viewOrderDetails(order) {
            const modal = document.getElementById('orderDetailsModal');
            const modalBody = document.getElementById('orderDetailsModalBody');
            
            modalBody.innerHTML = `
                <h3 style="margin-bottom: 25px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-receipt"></i> Order Details
                </h3>
                
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.05)); 
                          border: 1px solid rgba(16, 185, 129, 0.2); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Tracking ID</p>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <p class="mono" style="font-weight: 700; color: var(--accent); font-size: 1.1rem;">${order.tracking_id}</p>
                                <button class="btn-3d btn-small btn-secondary" onclick="copyTrackingId('${order.tracking_id}')" style="padding: 6px 12px;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Status</p>
                            <span class="status-badge status-${order.status.toLowerCase()}" style="font-size: 0.9rem; padding: 8px 16px;">
                                <i class="fas fa-${getStatusIcon(order.status)}"></i>
                                ${order.status}
                            </span>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Customer Name</p>
                            <p style="font-weight: 700; font-size: 1.1rem;">${order.customer_name}</p>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Phone Number</p>
                            <p style="font-weight: 700; font-size: 1.1rem;">
                                <a href="tel:${order.phone_number}" style="color: var(--accent); text-decoration: none;">
                                    <i class="fas fa-phone"></i> ${order.phone_number}
                                </a>
                            </p>
                        </div>
                    </div>
                    
                    ${order.address ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Delivery Address</p>
                            <p style="font-size: 1rem;">${order.address}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(129, 140, 248, 0.05)); 
                          border: 1px solid rgba(99, 102, 241, 0.2); padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h4 style="margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-box"></i> Product Information
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Product Name</p>
                            <p style="font-weight: 700; font-size: 1.1rem;">${order.product_name}</p>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Quantity</p>
                            <p style="font-weight: 700; font-size: 1.1rem; color: var(--accent);">${order.quantity}</p>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Unit Price</p>
                            <p class="mono" style="font-weight: 700; font-size: 1.1rem;">Rs. ${order.price.toLocaleString()}</p>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Total Amount</p>
                            <p class="mono" style="font-weight: 800; font-size: 1.3rem; color: var(--success);">
                                Rs. ${order.total.toLocaleString()}
                            </p>
                        </div>
                    </div>
                    
                    ${order.requirements ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 8px;">Special Requirements</p>
                            <p style="font-size: 1rem; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">${order.requirements}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 5px;">Order Placed</p>
                            <p style="font-weight: 600;">${new Date(order.created_at).toLocaleString()}</p>
                        </div>
                        <div>
                            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 5px;">Order ID</p>
                            <p class="mono" style="font-weight: 600; font-size: 0.9rem;">${order.id}</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    ${order.status === 'Pending' ? `
                        <button class="btn-3d btn-success" onclick="updateOrderStatus('${order.tracking_id}', 'Confirmed'); closeOrderDetailsModal()" style="flex: 1; min-width: 150px;">
                            <i class="fas fa-check"></i> Confirm Order
                        </button>
                    ` : ''}
                    ${order.status !== 'Cancelled' ? `
                        <button class="btn-3d btn-danger" onclick="updateOrderStatus('${order.tracking_id}', 'Cancelled'); closeOrderDetailsModal()" style="flex: 1; min-width: 150px;">
                            <i class="fas fa-times"></i> Cancel Order
                        </button>
                    ` : ''}
                    <button class="btn-3d btn-secondary" onclick="closeOrderDetailsModal()" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            modal.classList.add('open');
        }

        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').classList.remove('open');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function isToday(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) {
                console.log('Toast:', message);
                return;
            }
            
            toast.textContent = message;
            toast.className = 'show';
            
            // Remove any existing type classes
            toast.classList.remove('success', 'error', 'warning');
            
            // Add type class
            if (type === 'success') {
                toast.classList.add('success');
                toast.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(52, 211, 153, 0.9))';
                toast.style.border = '1px solid rgba(16, 185, 129, 0.3)';
            } else if (type === 'error') {
                toast.classList.add('error');
                toast.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(248, 113, 113, 0.9))';
                toast.style.border = '1px solid rgba(239, 68, 68, 0.3)';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                toast.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(251, 191, 36, 0.9))';
                toast.style.border = '1px solid rgba(245, 158, 11, 0.3)';
            } else {
                toast.style.background = 'rgba(30, 41, 59, 0.95)';
                toast.style.border = '1px solid rgba(255, 255, 255, 0.1)';
            }
            
            setTimeout(() => {
                toast.className = '';
            }, 4000);
        }

        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            try {
                await window.supabaseClient.auth.signOut();
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Failed to logout', 'error');
            }
        }

        // ==================== REAL-TIME UPDATES ====================
        function setupRealtime() {
            if (!window.supabaseClient) return;
            
            window.supabaseClient
                .channel('products-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'products' },
                    (payload) => {
                        console.log('Product change detected:', payload.eventType);
                        loadProducts();
                        loadDashboardStats();
                    }
                )
                .subscribe();
            
            window.supabaseClient
                .channel('orders-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'orders' },
                    (payload) => {
                        console.log('Order change detected:', payload.eventType);
                        loadOrders();
                        loadDashboardStats();
                    }
                )
                .subscribe();
        }

        // ==================== FILTER PRODUCTS ====================
        function filterProducts(filter) {
            let filtered = allProducts;
            
            switch(filter) {
                case 'in_stock':
                    filtered = allProducts.filter(p => (p.stock || 0) > 0);
                    break;
                case 'out_of_stock':
                    filtered = allProducts.filter(p => (p.stock || 0) === 0);
                    break;
                case 'low_stock':
                    filtered = allProducts.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 5);
                    break;
            }
            
            displayProducts(filtered);
            
            // Update active filter chip
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            const clickedChip = document.querySelector(`.filter-chip[onclick*="${filter}"]`);
            if (clickedChip) {
                clickedChip.classList.add('active');
            }
        }

        // ==================== QUICK ACTIONS ====================
        function showOutOfStock() {
            showSection('products');
            
            setTimeout(() => {
                const outOfStockProducts = allProducts.filter(p => (p.stock || 0) === 0);
                displayProducts(outOfStockProducts);
                
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                
                const outOfStockChip = document.querySelector('.filter-chip[onclick*="out_of_stock"]');
                if (outOfStockChip) {
                    outOfStockChip.classList.add('active');
                }
                
                document.getElementById('productSearch').value = '';
                
                showToast(`Showing ${outOfStockProducts.length} out of stock products`, 'info');
            }, 100);
        }

        // ==================== EXPORT ORDERS ====================
        async function exportOrders() {
            try {
                const { data: orders, error } = await window.supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!orders || orders.length === 0) {
                    showToast('No orders to export', 'warning');
                    return;
                }
                
                const csvData = convertToCSV(orders);
                downloadCSV(csvData, `orders_export_${Date.now()}.csv`);
                
                showToast(`‚úÖ Exported ${orders.length} orders`, 'success');
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showToast('Failed to export orders', 'error');
            }
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = [
                'Tracking ID',
                'Customer Name',
                'Phone Number',
                'Product',
                'Quantity',
                'Unit Price',
                'Total',
                'Status',
                'Order Date',
                'Address',
                'Requirements'
            ];
            
            const rows = data.map(order => [
                order.tracking_id,
                order.customer_name,
                order.phone_number,
                order.product_name,
                order.quantity,
                order.price,
                order.total,
                order.status,
                new Date(order.created_at).toLocaleString(),
                order.address || '',
                order.requirements || ''
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => 
                    row.map(cell => 
                        `"${String(cell).replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // ==================== BULK ACTIONS ====================
        function applyBulkAction() {
            const bulkAction = document.getElementById('bulkAction').value;
            
            if (!bulkAction) {
                showToast('Please select a bulk action', 'warning');
                return;
            }
            
            if (selectedOrders.size === 0) {
                showToast('No orders selected', 'warning');
                return;
            }
            
            if (bulkAction === 'confirm') {
                if (confirm(`Confirm ${selectedOrders.size} order(s)?`)) {
                    selectedOrders.forEach(trackingId => {
                        updateOrderStatus(trackingId, 'Confirmed');
                    });
                    selectedOrders.clear();
                    updateSelectedCount();
                }
            } else if (bulkAction === 'cancel') {
                if (confirm(`Cancel ${selectedOrders.size} order(s)?`)) {
                    selectedOrders.forEach(trackingId => {
                        updateOrderStatus(trackingId, 'Cancelled');
                    });
                    selectedOrders.clear();
                    updateSelectedCount();
                }
            }
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = 
                `${selectedOrders.size} order(s) selected`;
        }

        console.log('‚úÖ Enhanced Admin.js loaded successfully');
    </script>
</body>
</html>
